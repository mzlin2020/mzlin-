# 前端拓展

```js
@title '前端拓展知识' 
@description '微前端、性能测试与指标，性能优化等'
@image 'https://gw.alipayobjects.com/zos/rmsportal/JiqGstEfoWAOHiTxclqi.png'
```

## 一、微前端



微前端是一种软件架构，可以将前端应用拆解成一些更小的能够独立开发部署的微信应用，然后再将这些微应用进行组合使其成为整体应用的架构模式

微前端架构类似于组件架构，不同的是，组件不能独立构建和发布，微前端可以。

微前端架构与框架无关，每个微应用都可以使用不同的框架



**价值**

1、增量迁移

可在保留原有项目的同时，使用新的框架开发新的需求。然后再使用微前端架构将旧的项目和新的项目进行整合

2、独立发布

将项目拆分成独立的应用，各个应用可以单独构建发布，极大提升了构建时间

3、允许单个团队做出技术决策

每个团队可以使用自己擅长的技术栈进行开发



**使用场景**

1、拆分巨型应用，使应用变得更加可维护

2、兼容历史应用，实现增量开发



## 二、性能指标与测量

### 2.1 web性能

**是什么？**

打开速度、动画效果、表单提交、列表滚动、页面切换......



MDN上的Web性能定义：Web性能是网站或应用程序的客观度量和可感知的用户体验

+ **减少整体加载时间：**减小文件体积、较少HTTP请求、使用预加载
+ **减少白屏时间：**仅加载首屏内容，懒加载
+ **平滑和交互性：**css动画替换js动画、减少UI重绘
+ **感知表现：**利用特殊的方式让用户以为很快，例如加载动画，进度条、骨架屏等
+ **性能测定：**性能指标、性能测试、性能监控持续优化



**怎么做？**

(1) 首先需要了解性能指标-多快才算快？
(2) 使用专业的工具可量化地评估出网站或应用的性表现：
(3) 然后立足于网站页面响应的生命周期，分析出造成较差性能表现的原因：
(4) 最后进行技术改造、可行性分析等具体的优化实施。
(5) 迭代优化



**性能指标**

+ RAIL 性能模型
+ 基于用户体验的核心指标
+ 新一代性能指标：Web Vitals



**性能测量**

+ 浏览器DevTools调试工具
  + 网络监控分析
  + 性能监控分析
  + ...
+ 灯塔（Lighthouse）
  + 网站整体质量评估，并给出优化建议
+ WebPageTest
  + 多测试地点
  + 全面的性能报告



### 2.2 性能指标

#### 1、RAIL 性能模型

RAIL 是Response、Animation、Idle、Load的首字母缩写，是一种由Google Chrome团队于2015年提出的性能模型，用于提升浏览器内的用户体验和性能

理念：以用户为中心，最终目标不是让网站在任何特定设备上都能运行很快，而是使用户满意

![](img\拓展\RAIL性能模型.png)



+ 响应(Response)：应该尽可能快速的响应用户，应该在100ms以内响应用户输入。
+ 动画(Animation)：在展示动画的时候，每一帧应该以16ms进行渲染，这样可以保持动画效果的一致性，并且避免卡顿。
+ 空闲(Idle)：当使用js主线程的时候，应该把任务划分到执行时间小于50ms的片段中去，这样可以释放线程以进行用户交互。
+ 加载(Load)：应该在小于1s的时间内加载完成你的网站，并可以进行用户交互。



#### 2、基于用户体验的性能指标

该指标是Google在web.dev上提出，需要衡量的指标包括一下几点：

- [First Contentful Paint 首次内容绘制 (FCP)](https://web.dev/fcp/)
- [Largest Contentful Paint 最大内容绘制 (LCP)](https://web.dev/lcp/)
- [First Input Delay 首次输入延迟 (FID)](https://web.dev/fid/)
- [Time to Interactive 可交互时间 (TTI)](https://web.dev/tti/)
- [Total Blocking Time 总阻塞时间 (TBT)](https://web.dev/tbt/)
- [Cumulative Layout Shift 累积布局偏移 (CLS)](https://web.dev/cls/)





**First Contentful Paint（FCP）**

首次内容绘制，浏览器首次绘制来自DOM的内容的时间，内容必须是文本、图片（包含背景图）、非白色的canvas或SVG,也包括带有正在加载中的Web字体的文本



速度指标

![](E:\学习笔记汇总\img\拓展\FCP.png)

优化方案

https://web.dev/fcp/#how-to-improve-fcp



**Largest Contentful Paint（LCP）**

LCP最大内容绘制，可视区域中最大的内容元素呈现到屏幕上的时间，用以估算页面的主要内容对用户可见时间。

```js
1、LCP考虑的元素：<img>元素
2、<image>元素内的<svg>元素
3、<video>元素（封面图）
4、通过ul()函数加载背景图片的元素
5、包含文本节点或其他内联级文本元素子级的块级元素
```

为了提供良好的用户体验，网站应力争使用2.5秒或更短的“最大内容绘画”。为确保您达到大多数用户的这一目标，衡量移动设备和台式机设备的页面加载量的第75个百分位数是一个很好的衡量标准



速度指标

![](E:\学习笔记汇总\img\拓展\LCP.png)

优化方案

https://web.dev/optimize-lcp/



**First Input Delay（FID）**

首次输入延迟，从用户第一次与页面交互（例如单击链接、点击按钮等）到浏览器实际能够响应该交互的时间。

输入延迟是因为浏览器的主线程正忙于做其他事情，所以不能响应用户。发生这种情况的一个常见原因是浏览器正忙于解析和执行应用程序加载的大量计算的JavaScript。

```html
    <input type="text">
    <script>
        setTimeout(() => {
            for(let i = 0; i < 10000000000; i++){}
        }, 0)
    </script>
```

> 需等到js执行完毕，输入框才能输入内容



第一次输入延迟通常发生在第一次内容绘制(FCP)和可持续交互时间(TT)之间，因为页面已经呈现了一些内容，但还不影可靠地交互。



例如，以下所有HTML元素邹需要在响应用户交互之前等待主线程上正在进行的任务完成：

```js
1、文本输入框，复选框和单选按钮(<input>,<textarea>)
2、选择下拉菜单(<select>)
3、链接(<a>)
```



速度指标

![](E:\学习笔记汇总\img\拓展\FID.png)

优化方案

https://web.dev/fid/#how-to-improve-fid

https://web.dev/optimize-fid/



**Time to Interactive（TTI）**

表示网页第一次完全达到可交互状态的时间点，浏览器已经可以持续性的响应用户的输入。完全达到可交互状态的时间点是在最后一个长任务(Long Task)完成的时间，并且在随后的5秒内网络和主线程是空闲的。

从定义上来看，中文名称叫可持续交互时间或可流畅交互时间更合适。

> 长任务指的是50ms以上才能完成的任务

速度指标

![](E:\学习笔记汇总\img\拓展\TTI.png)

优化方案

https://web.dev/tti/#how-to-improve-tti



**Total Block Time（TBT）**

Total Block Time(TBT)总阻塞时间，度量了FCP和TTI之间的总时间，在该时间范围内，主线程被阻塞足够长的时间以防止输入响应。

只要存在长任务，该主线程就会被视为“阻塞”，该任务在主线程上运行超过50毫秒(ms)。我们说主线程“被阻止”是因为浏览器无法中断正在进行的任务。因此，如果用户确实在较长的任务中间与页面进行交互，则浏览器必须等待任务完成才能响应。
如果任务足够长（例如，超过50毫秒的任何时间），则用户很可能会注意到延迟并感觉页面缓慢或过时。

给定的长任务的阻止时间是其持续时间超过50毫秒。页面的总阻塞时间是FCP和TTI之间发生的每个长任务的阻塞时间的总和。

速度指标

![](E:\学习笔记汇总\img\拓展\TBT.png)

优化方案

https://web.dev/tbt/#how-to-improve-tbt



**Cumulative Layout Shift（CLS）**

累计布局偏移，CLS会测量在页面整个生命周期中发生的每个意外的布局移位的所有单独布局移位分数的总和，它是一种保证页面的视觉稳定性，从而提升用户体验的指标方案



页面内容的意外移动通常是由于异步加载资源或将DOM元素动态添加到现有内容上方的页面而发生的。罪魁祸首可能是尺寸未知的图像或视频，呈现比其后备更大或更小的字体，或者是动态调整自身大小的第三方广告或小部件。

速度指标

![](E:\学习笔记汇总\img\拓展\CLS.png)

优化方案

https://web.dev/cls/#how-to-improve-cls

https://web.dev/optimize-cls/



#### 4、Web Vitals

Web Vitals的计划降低了学习成本，为网站体验提供了一组统一的质量衡量指标一Core Web Vitals,其中包括加载体验、交互性和页面内容的视觉稳定性。



背景：过去要衡量一个网站的好坏，需要使用的指标太多了，Web Vitals可以简化指标的学习曲线，只需聚焦于Web Vitals指标的表现即可。

三个主要衡量指标：加载性能、交互性、视觉稳定

```js
1、加载性能(LCP)一显示最大内容元素所需时间
2、交互性(FD)一首次输入延迟时间
3、视觉稳定性(CLS)一累积布局配置偏移
```



**测量Web vitals**

+ 性测试工具，比如Lighthouse

+ 使用web-vitals库

+ 使用浏览器插件Web Vitals（谷歌商店下载）



**优化**

https://web.dev/optimize-lcp/

https://web.dev/optimize-fid/

https://web.dev/optimize-cls/



### 2.3 性能测试

#### 1、灯塔Lighthouse

Lighthouse 直译过来是“灯塔”的意思，它是由 Google 开发并开源的一个 Web 性能测试工具。

该性能检测工具以此命名也蕴涵了相同的含义，即通过监控和检测网站应用的各方面性能表现，来为开发者提供优化用户体验和网站性能的指导建议。 



**使用方式**

Lighthouse 提供了多种使用方式。

●[在 Chrome DevTools 中使用 Lighthouse](https://github.com/GoogleChrome/lighthouse#using-lighthouse-in-chrome-devtools)（chrome浏览器直接使用，无需下载）

●[使用 Chrome 扩展](https://github.com/GoogleChrome/lighthouse#using-the-chrome-extension)

●[使用 Node CLI 命令行工具](https://github.com/GoogleChrome/lighthouse#using-the-node-cli)

●[使用 Node 包](https://github.com/GoogleChrome/lighthouse#using-the-node-module)



**chrome devtools**

选择测试项目

![](E:\学习笔记汇总\img\拓展\lighthouse选择.png)

测试报告

![](E:\学习笔记汇总\img\拓展\lighthouse性能报告.png)



6种不同的指标数据需要通过加权计算，才能得到关于性能的最终评分，所加的权值越大表示对应指标对性能的影响就越大，如下图所示，列出了目前 Lighthouse 的权重情况。 

![](E:\学习笔记汇总\img\拓展\lighthouse权重.png)

**优化建议**

 为了方便开发者更快地进行性能优化，Lighthouse 在给出关键性能指标评分的同时，还提供了一些切实可行的优化建议

 这些建议按照优化后预计能带来的提升效果从高到低进行排列，每一项展开又会有更加详细的优化指导建议，从上到下依次包括以下内容。

（1）移除阻塞渲染的资源

（2）预连接所要请求的源，提前建立与所要访问资源之间的网络连接，或者加快域名的解析速度都能有效地提高页面的访问性能

（3）降低服务器端响应时间

（4）适当调整图片大小

（5）移除未使用的CSS



#### 2、WebPageTest

[WebPageTest](https://www.webpagetest.org/) 是一款非常专业的 Web 页面性能分析工具，它可以对检测分析的环境配置进行高度自定义化，内容包括测试节点的物理位置、设备型号、浏览器版本、网络条件和检测次数等，除此之外，它还提供了目标网站应用于竞品之间的性能比较，以及查看网络路由情况等多种维度下的测试工具。 



可直接打开 WEBPAGETEST 的主页面，在配置好目标网站应用的网址和检测参数后便可启动测试，等待检测运行结束就能查看详细的测试报告。 



#### 3、 **Chrome DevTools 测试性能** 

**浏览器任务管理器** 

通过 Chrome 任务管理器我们可以查看当前 Chrome 浏览器中，所有进程关于 GPU、网络和内存空间的使用情况，这些进程包括当前打开的各个页签，安装的各种扩展插件，以及 GPU、网络、渲染等浏览器的默认进程，通过监控这些数据，我们可以在有异于其他进程的大幅开销出现时，去定位到可能存在内存泄漏或网络资源加载异常的问题进程。 

位置：更多工具--任务管理器



**Network 网络分析 **

Network 面板是 Chrome 开发者工具中一个经常会被用到的工具面板，通过它可以查看到网站所有资源的请求情况，包括加载时间、尺寸大小、优先级设置及 HTTP 缓存触发情况等信息，从而帮助我们发现可能由于未进行有效压缩而导致资源尺寸过大的问题，或者未合理配置缓存策略导致二次请求加载时间过长的问题等。 



>  网络请求阻止
>
> ●打开方式：Ctrl+ Shift + P -> Show Network Request Blocking
> ●启用网络请求阻止
> ●添加阻止规则 
>
> 可以阻止某一资源的加载



**Coverage 面板** 

可以通过 Coverage 面板监控并统计出网站应用运行过程中代码执行的覆盖率情况。该面板统计的对象是 JavaScript 脚本文件与 CSS 样式表文件，统计结果主要包括：每个文件的字节大小、执行过程中已覆盖的代码字节数，以及可视化的覆盖率条形图。 



使用：Ctrl+ Shift + P  ---- coverage



根据执行结果我们能够发现，在启动录制的过程中到底有哪些尺寸较大的代码文件执行覆盖率较低，这就意味着有些代码文件中可能存在较多的无用代码，更准确地说是暂时没用到的代码。这些信息对性能优化来说是非常有用的，开发者可以据此将执行覆盖率较低的代码文件进行拆分，将首屏渲染阶段暂时不会执行到的代码部分单独打包，仅在需要的时候再去加载。

同时对规模较大且迭代周期较长的项目来说，工程代码中会包含一些永远都不会执行到的代码，而使用 webpack 的 Tree Shaking 仅能根据 export 进行无关联引用，那么此时 Coverage 面板就为优化提供了一条可以尝试的途径 





## 三、性能优化

### 3.1 请求和响应优化

 目的：更快的内容到达时间



核心思路：

+ 更好的连接传输效率
+ 更少的请求数量
+ 更小的资源大小
+ 合适的缓存策略



最佳实践：

**1、减少 DNS 查找**：每次主机名的解析都需要一次网络往返，从而增加了请求的延迟时间，同时还会阻塞后续的请求。
**2、重用 TCP 连接**：尽可能的使用持久连接，以消除因 TCP 握手和慢启动导致的延迟。
**3、减少 HTTP 重定向**：HTTP 冲定向需要额外的 DNS 查询、TCP 握手等非常耗时，最佳的重定向次数为0。
**4、压缩传输的资源**：比如 Gzip、图片压缩。
**5、使用缓存**：比如 HTTP 缓存、CDN 缓存、Service Worker 缓存。
**6、使用 CDN**（内容分发网络）：把数据放在离用户地理位置更近的地方，可以明显减少每次 TCP 连接的网络延迟，增大吞吐量。
**7、删除没有必要请求的资源。**
**8、在客户端缓存资源**：缓存必要的应用资源，避免每次都重复请求相同的内容，例如多图片下载可以考虑使用缓存。
**9、内容在传输前先压缩**：传输数据之前应该先压缩应用资源，把要传输的字节减少到最小，在压缩的时候确保对每种不同的资源采用最好的压缩手段。
**10、消除不必要的请求开销**：减少请求的 HTTP 首部数据（比如 HTTP COokie）
**11、并行处理请求和响应**：请求和响应的排队都会导致延迟，可以尝试并行的处理请求和响应（利用多个 HTTP1.1 连接实现并行下载，在可能的情况下使用 HTTP 管道计数）。
**12、针对协议版本采取优化措施**。升级到 HTTP2.0。
**13、根据需要采用服务端渲染方式**。这种方式可以解决 SPA 应用首屏渲染慢的问题。
**14、采用预渲染的方式快速加载静态页面**。页面渲染的极致性能，比较适合静态页面。 





### 3.1 DNS解析

典型的一次 DNS 解析需要耗费 **20-120** 毫秒，所花费的时间几乎可以忽略不计，但是当网站中使用的资源依赖于多个不同的域的时候，时间就会成倍的增加，从而增加了网站的加载时间 



优化要点：

1、减少DNS请求次数

2、进行DNS预获取：DNS Prefetch



**减少DNS请求次数**

 缓存 DNS 查找以提高性能， 大多数浏览器都有自己的缓存，与操作系统的缓存分开。 



>  Firefox 在 配置设置的控制下缓存 DNS 查找1分钟。Chrome 也是1分钟。



当客户端的 DNS 缓存为空（对于浏览器和操作系统）时，DNS 查找的次数等于网页中唯一主机名的数目。这包括在页面的 URL，图像，脚本文件，样式表，Flash 对象等中使用的主机名。减少唯一主机名的数量将减少 DNS 查找的数量。 



做法： 减少域名的数量有可能减少页面中并行下载的数量。 

> 思考：有些资源就需要放在其他服务器，避免给同一台服务器太大负担，所以最好**将这些资源划分为至少两个但不超过四个域名** 



## 四、权限设计



### 4.1 功能层面的权限

通过二进制位来设计权限

```js
//建立一个规则表来表示页面所有的权限
const CREATE = 0b0001;
const DELETE = 0b0010;
const UPDATE = 0b0100;
const DETAIL = 0b1000;
```



```js
//分配权限
//表示manager拥有创建和删除的权限
const manager = CREATE | DELETE 
```

> 二进制的或运算是将两个二进制数的对应位进行比较，只要其中一个位上的数为1，结果就为1，否则结果为0



```js
//判定权限
//判断manager用户是否拥有CREATE权限
const isPower = (manager & DELETE) === CREATE
```

> // 二进制的与运算是将两个二进制数的对应位进行比较，只有两个位上的数都为1时，结果才为1，否则结果为0





















