# 项目部署

## 一、服务端项目部署

### 1.1连接服务器

环境：git bash

1、`ssh root@公网IP`

2、输入密码

### 1.2 安装node

安装软件使用的⼯具：dnf

**DNF**，全称**Dandified**（时髦的、华丽的） **Yum**，是Yum的下⼀个版本，也被称之为Yum的替代品；

如果服务器选择的是centos8，所以是⾃带dnf的；

检查dnf是否可⽤：`dnf --help`

```shell
#搜索软件包
dnf search nodejs

#查看软件包信息：noedjs的版本是10.21.0
dnf info nodejs

#安装nodejs
dnf install nodejs
```

我们会发现版本其实是10.21.0：

我们其实希望使用更高的版本，比如最新的LTS或者Current版本；

```shell
# 安装
npm install n -g

#通过n安装最新的lts和current
n install lts
n install latest

#通过n切换版本
n
```

### 1.3 安装数据库

使用dnf安装mysql

```shell
#查看mysql
dnf search mysql-server

#查看mysql详情
dnf info mysql-server

#安装mysql，-y表示依赖的内容也安装
dnf install mysql-server -y
```

启动

```shell
#开启mysql后台服务
systemctl start mysqld

#查看mysql服务：active(running)表示启动成功
systemctl status mysql

#随着系统一起启动
systemctl enable mysqld
```

**配置mysql**

```shell
mysql_secure_installation

#密码强度推荐选择2
```

操作数据库

```shell
mysql -u root -p
#输入密码
password


#显示所有的数据库
show datebases;

```

### 1.4 GUI工具连接服务器

1、配置安全组

通过命令行操作数据库显示不太方便，我们也可以通过GUI工具连接远程服务器，直接在GUI工具中操作数据库

但是连接GUI工具需要配置mysql3306端口，默认阿里云的这个端口是不放行的，需要自己去配置**安全组配置**

2、修改默认mysql数据库

修改mysql中的user表，使其能够添加其他用户登录。不只限于本地连接

```shell
#显示当前所有数据库
show databases;

#进入mysql数据库
use mysql;

#查看user表中的host、user
select host,user from user;

#修改
update user set host ='%' where user = 'root';
```

3、连接远程服务器

4、数据库迁移

将项目的数据库保存到本地，并在服务器中上传

### 1.5 通过git仓库部署项目

先来了解一下简单的Linux命令：

```shell
#退出
exit

#当前文件夹下的所有文件
ls

#当前位置
pwd

#创建文件夹
mkdir 文件夹名
```

1、在服务器终端的根目录下，创建一个项目文件夹coderhub，进行文件夹，并将项目从git上克隆下来

2、为服务器安装git`dnf install git`

3、克隆项目：`git clone 地址`

4、安装vscode插件（remote SSH），使得我们可以通过vscode连接远程服务器，直接操作服务器中的项目

使用remote SSH需要输入：`ssh root@服务器公网ip`，连接时需要输入密码（选择linux）

注：如果报错了“试图写入的管道不存在”，需要修改.ssh文件夹下deconfig的权限

5、在vscode打开服务器的项目，并修改env

6、启动项目 `node ./src/main.js`,如果还不能访问的话，需要去配置安全组（端口）

尝试打开保存项目中的图片`http://47.106.182.193:8000/upload/12/avatar`成功！！

### 1.6 pm2启动项目

在真实的部署过程中，我们会使用⼀个⼯具pm2来管理Node的进程：

PM2是⼀个Node的进程管理器，我们可以使用它来管理Node的后台进程；

这样在关闭终端时，Node进程会继续执行，那么服务器就可以继续为前端提供服务了；

安装`npm install pm2 -g`

常用命令

```shell
#命令进程
pm2 start app.js --name my-api

#显示所有进程状态
pm2 list

#停止指定进程
pm2 stop 0

#停止所有进程
pm2 stop all

#重启所有进程
pm2 restart all

#重启指定进程
pm2 restart 0

#杀死指定的进程
pm2 delete 0 

#杀死全部进程
pm2 delete all 

#后台运行pm2 启动4个app.js，实现负载均衡
pm2 start app.js -i 4
```

启动coderhub项目

`pm2 start ./src/main.js --name coderhub`

# 二、 jenkins自动化部署

### 2.1 连接服务器

环境：git bash

1、`ssh root@公网IP`

2、输入密码



### 2.2 安装jenkins

**1、安装java**

Jenkins本身是依赖Java的，所以我们需要先安装Java环境

* 这里我安装了Java1.8的环境

```shell
dnf search java-1.8
dnf install java-1.8.0-openjdk.x86_64
```

**2、安装Jenkins**

因为Jenkins本身是没有在dnf的软件仓库包中的，所以我们需要连接Jenkins仓库：

* wget是Linux中下载文件的一个工具，-O表示输出到某个文件夹并且命名为什么文件；
* rpm：全称为**The RPM Package Manage**，是Linux下一个软件包管理器；

```shell
wget –O /etc/yum.repos.d/jenkins.repo http://pkg.jenkins-ci.org/redhat-stable/jenkins.repo
```

注：如果发现安装在了root，那么是错误的。必须安装在etc文件下

执行`mv jenkins.repo /etc/yum.repos.d`，将root下的`jenkins.repo`转移到etc文件夹下

执行`cd /etc/yum.repos.d/`进入该文件夹下，执行`ls`查看是否有`kenkins,repo`文件，如果有，说明我们之前的步骤是没错的

```shell
# 导入GPG密钥以确保您的软件合法
rpm --import https://pkg.jenkins.io/redhat/jenkins.io.key
# 或者
rpm --import http://pkg.jenkins-ci.org/redhat/jenkins-ci.org.key
```

编辑一下文件/etc/yum.repos.d/jenkins.repo文件

```js
vi jenkins.repo
//按一次键盘上的i

//删除多余的字母
baseurl=http://pkg.jenkins.io/redhat

//退出 esc
//按住shift :
//输入wq
```

这次，可以真正进行安装了

```shell
dnf install jenkins
```

启动Jenkins的服务：

```shell
systemctl start jenkins
systemctl status jenkins
systemctl enable jenkins
//输入
/usr/lib/systemd/systemd-sysv-install enable jenkins
```

Jenkins默认使用8080端口提供服务，所以需要加入到安全组中

之后，可以通过`公网ip：8080`访问图形化界面



那么管理员密码是多少呢？

复制` cat /var/lib/jenkins/secrets/initialAdminPassword`到服务器上，就可以得到密码了

创建第一个管理员用户

```js
//用户名：mzlin
//邮箱：mzlin2020
```

### 2.3 nginx安装和配置

后续我们部署会使用nginx，所以需要先安装一下nginx：

```shell
dnf install nginx
```

启动nginx：

```shell
systemctl start nginx
systemctl status nginx
systemctl enable nginx
```

检查nginx也可以通过`ip地址：80`,在浏览器打开，可以看到一个红色的页面

意味着，之后通过IP地址访问，会进入到这个界面。所以，我们可以将这个页面替换成我们项目的界面

**查看nginx的初始化页面**

```js
//进入该目录
cd /usr/share/nginx/html

//查看当前目录已有的文件(可以看到index.html)
ls
//查看代码
vi index.html
```

**创建自己项目的目录**

```js
cd /root/
    
//创建项目
mkdir mall

//创建文件
touch index.html
```

**编辑index.html**

```js
vi index.html

//按键盘i 进入编辑模式
//退出编辑模式：esc
//退出文件：按住shift :输入wq，保存并退出
```

所以，现在我们的mall项目有了自己的index.html文件，如果将ip地址的访问指向这个文件呢？

修改nginx

我们可以通过远程（vscode）的方式，修改代码

打开nginx(etx/nginx/nginx.conf)的配置文件，并进行修改

```js
//nginx.conf

//将user nginx; 改为 user root
//注释root   /usr/share/nginx/html;
//配置
        location / {
            root /root/mall;
            index index.html;
        }
//注：冒号一定要加上
```

打开命令行，重启nginx `systemctl restart nginx`

现在，我们的ip地址已经默认指向mall目录下的index.html代码了





那么我们如何将项目上传至服务器的mall目录呢？通过GitHub

创建一个新的仓库，并将本地代码push上去（注意：由于项目是由脚手创建的，并且本地已下载git，所以默认有.git文件）

并且我们需要自动化部署，需要让Jenkins每隔一段时间到GitHub上取一次代码

### 2.4 jenkins自动化部署

(服务器需要安装git)

1、在jenkins创建一个新项目

2、源码管理的url填GitHub项目的url

3、指定分支为`*/main`

4、触发构建器——定时构建

这里的触发器规则是这样的：

* 定时字符串从左往右分别是：分 时 日 月 周

```js
#每半小时构建一次OR每半小时检查一次远程代码分支，有更新则构建
H/30 * * * *

#每两小时构建一次OR每两小时检查一次远程代码分支，有更新则构建
H H/2 * * *

#每天凌晨两点定时构建
H 2 * * *

#每月15号执行构建
H H 15 * *

#工作日，上午9点整执行
H 9 * * 1-5

#每周1,3,5，从8:30开始，截止19:30，每4小时30分构建一次
H/30 8-20/4 * * 1,3,5
```

5、构建环境

这里一开始是没有`Provide Node & npm bin/folder to PATH`这一选项的

需要先在jenkins安装node：（回到jenkins首页，在manage jenkins中选择manage plugins，并在其中查找node，最后进行下载并重启）



6、构建

选择执行shell

```shell
node -v
npm -v
npm install
npm run build

pwd
echo '构建成功'

ls

#删除/root/nall文件里所有的内容
rm /root/mall/* -rf
cp -rf ./dist/* /root/mall/
```

有可能jenkins没有权限，所以还需要配置一下etc/sysconfig/jenkins

修改`JENKINS_USER="jenkins"` 修改为root

修改后重新启动`systemctl restart jenkins`



7、保存，并立即构建

